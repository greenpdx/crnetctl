name: Issue Triage

on:
  issues:
    types: [opened]

jobs:
  triage:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Triage issue with Claude
        id: triage
        uses: actions/github-script@v7
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          script: |
            const https = require('https');
            const issue = context.payload.issue;
            const issueContent = 'Title: ' + issue.title + '\n\nBody:\n' + (issue.body || '(no description)');
            
            const promptText = 'You are a helpful code triage assistant. Analyze this GitHub issue and provide:\n1. A brief 1-2 sentence summary of the issue\n2. Suggested labels (bug, feature, documentation, question, etc.)\n3. Priority level (critical, high, medium, low)\n4. If it includes code, any initial observations about the code\n\nIssue to analyze:\n' + issueContent + '\n\nFormat your response as:\nSUMMARY: [summary here]\nLABELS: [comma-separated labels]\nPRIORITY: [critical/high/medium/low]\nCODE_NOTES: [any code observations, or N/A if no code]';

            const requestBody = JSON.stringify({
              model: "claude-sonnet-4-5-20250929",
              max_tokens: 1024,
              messages: [
                {
                  role: "user",
                  content: promptText
                }
              ]
            });

            return new Promise((resolve, reject) => {
              const req = https.request('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'anthropic-version': '2023-06-01',
                  'x-api-key': process.env.ANTHROPIC_API_KEY,
                  'Content-Length': Buffer.byteLength(requestBody)
                }
              }, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  if (res.statusCode !== 200) {
                    reject(new Error('API error: ' + res.statusCode + ' - ' + data));
                    return;
                  }
                  const response = JSON.parse(data);
                  const result = response.content[0].text;
                  require('fs').writeFileSync('triage_result.txt', result);
                  resolve(result);
                });
              });

              req.on('error', reject);
              req.write(requestBody);
              req.end();
            });

      - name: Verify triage results
        run: cat triage_result.txt

      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const triageResult = fs.readFileSync('triage_result.txt', 'utf8');
            
            const comment = '## ðŸ¤– Automated Issue Triage\n\n' + triageResult + '\n\n---\n*This analysis was performed automatically by Claude. Please review and adjust as needed.*';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Apply labels
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const triageResult = fs.readFileSync('triage_result.txt', 'utf8');
            
            const labelsMatch = triageResult.match(/LABELS:\s*(.+?)(?:\n|$)/);
            if (!labelsMatch) return;
            
            const labels = labelsMatch[1]
              .split(',')
              .map(l => l.trim())
              .filter(l => l && l !== 'N/A');
            
            if (labels.length > 0) {
              github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: labels
              });
            }
